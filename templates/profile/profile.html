{% extends 'base.html' %}

{% block page_title %}
  profile
{% endblock page_title %}
{% block content %}
  <div class="">
    <div class="">
      <div class=""></div>
      <div class="">
        <img id="user-img" class="bg-cover bg-center w-64 h-64" src="#" alt="">
        <input id='file-input' type="file">
      </div>
      <div class="w-32">
        <button onclick="image_url()" class="flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">변경하기</button>
      </div>
    </div>
  </div>

  <script>
    function image_url() { // nst server 에 이미지 변환 요청하는 함수
      let original_image = ''
      let nst_image = ''

      let file = $('#file-input')[0].files[0];
      let form_data = new FormData();
      //file이름과 file을 formdata 로 변환
      form_data.append('key', 'aa');
      form_data.append('img', file);
      $
        .ajax({ //nst 서버에서 장고닌자로 만들었던 api upload 주소에 formdata와 함께 보낸다
          type: 'POST',
          url: 'http://127.0.0.1:8080/api/v1/upload',
          data: form_data,
          crossDomain: true,
          contentType: false,
          cache: false,
          processData: false,
          success: function (response) { // 성공적으로 response를 받으면 formdata를 url 받은걸로 수정
            form_data.delete('key')
            form_data.delete('img')
            form_data.append('original_file_url', response.original_file_url)
            form_data.append('nst_file_url', response.file_url)
            $("#user-img").attr("src", response.file_url); // nst url을 바로 넣어준다
          }
        })
        .then(function (response) { //then은 위에 ajax가 끝나면 바로 시작하는 함수
          $.ajax({ // 바로 ajax를 실행해서 여기 서버에서 만든 file url 저장하는 api에 데이터와 함께 보낸다
            type: 'POST',
            url: "{% url 'api-1.0.0:file' %}",
            data: form_data,
            contentType: false,
            cache: false,
            processData: false,
            success: function (response) {
              console.log(response)
            }
          })
        })
    }
  </script>
{% endblock %}
